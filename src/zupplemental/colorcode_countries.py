from numpy import array, shape, linspace, size, interp, digitize, stack, transpose, radians, sin
from shapely import Polygon

from zupplemental.helpers import load_shaperecords

colormap = array([
	[0.99999999, 0.99999999, 0.99999999],
	[0.99556162, 0.99626237, 0.99135456],
	[0.99211535, 0.99194267, 0.98449053],
	[0.98856226, 0.98769652, 0.97750716],
	[0.98495875, 0.9835134, 0.97028924],
	[0.98139289, 0.97936696, 0.96275236],
	[0.97794977, 0.97522507, 0.95487699],
	[0.97468146, 0.97106318, 0.94669538],
	[0.9715999, 0.9668694, 0.93827032],
	[0.96869495, 0.96264177, 0.92965272],
	[0.96594326, 0.95838365, 0.92089342],
	[0.96332357, 0.95409996, 0.91202009],
	[0.96081452, 0.9497959, 0.90305942],
	[0.95840426, 0.94547529, 0.8940141],
	[0.95607741, 0.94114193, 0.88490207],
	[0.95382395, 0.93679859, 0.87573047],
	[0.95163662, 0.93244734, 0.86650267],
	[0.94951921, 0.92808476, 0.85723317],
	[0.94759234, 0.92365789, 0.84795887],
	[0.94589644, 0.91914932, 0.8386792],
	[0.94443259, 0.91455543, 0.82941441],
	[0.9431991, 0.90987351, 0.82018562],
	[0.94219076, 0.90510211, 0.81101533],
	[0.94139939, 0.90024097, 0.8019258],
	[0.94081385, 0.89529111, 0.79293863],
	[0.94042033, 0.89025479, 0.78407418],
	[0.94020284, 0.88513545, 0.77535086],
	[0.94014417, 0.87993735, 0.76678427],
	[0.94022614, 0.87466559, 0.75838725],
	[0.94043071, 0.86932559, 0.75016982],
	[0.94074356, 0.86392131, 0.74214184],
	[0.94114463, 0.85846016, 0.73430484],
	[0.94161793, 0.85294796, 0.72665991],
	[0.94214736, 0.8473909, 0.71920696],
	[0.9427202, 0.84179417, 0.71194217],
	[0.94333035, 0.83615958, 0.70486712],
	[0.94396576, 0.83049246, 0.69797589],
	[0.94461176, 0.82479991, 0.69125784],
	[0.94526849, 0.81908135, 0.68471312],
	[0.94592734, 0.81334102, 0.67833378],
	[0.94657787, 0.80758447, 0.6721087],
	[0.94722605, 0.80180816, 0.66604144],
	[0.94785539, 0.79602141, 0.66011291],
	[0.94847577, 0.79021857, 0.65432952],
	[0.94907427, 0.78440727, 0.64867361],
	[0.9496553, 0.77858506, 0.64314568],
	[0.95021522, 0.77275403, 0.63773969],
	[0.95074928, 0.76691755, 0.63244286],
	[0.95126502, 0.76107092, 0.62726219],
	[0.95175646, 0.75521824, 0.6221834],
	[0.95222035, 0.74936155, 0.61720074],
	[0.95266152, 0.74349806, 0.61231469],
	[0.95308183, 0.73762685, 0.6075215],
	[0.95347623, 0.73175121, 0.60281212],
	[0.95384523, 0.72587095, 0.59818318],
	[0.95418885, 0.71998613, 0.5936316],
	[0.95451267, 0.71409268, 0.5891649],
	[0.95478325, 0.70820408, 0.5848437],
	[0.95501336, 0.70231341, 0.58066516],
	[0.95520055, 0.69642185, 0.57663212],
	[0.95534248, 0.69053057, 0.57274723],
	[0.95543337, 0.68464223, 0.56902019],
	[0.95546713, 0.67875972, 0.56546152],
	[0.95544792, 0.6728819, 0.56205835],
	[0.95537387, 0.66700999, 0.55881225],
	[0.95524213, 0.66114585, 0.5557245],
	[0.95504202, 0.65529463, 0.55281525],
	[0.95477723, 0.64945557, 0.55007195],
	[0.95444855, 0.64362907, 0.5474889],
	[0.95405402, 0.63781681, 0.54506581],
	[0.95358533, 0.63202333, 0.54281669],
	[0.95304257, 0.62624955, 0.54073691],
	[0.95242945, 0.62049475, 0.53881366],
	[0.95174481, 0.61476039, 0.53704495],
	[0.95098282, 0.60905012, 0.5354396],
	[0.95014161, 0.60336584, 0.53399779],
	[0.9492271, 0.59770576, 0.53270209],
	[0.94823896, 0.59207098, 0.5315491],
	[0.94717591, 0.58646304, 0.53053837],
	[0.94603087, 0.58088635, 0.52968282],
	[0.94481339, 0.57533714, 0.52895789],
	[0.94352419, 0.56981584, 0.52835946],
	[0.94216406, 0.56432286, 0.52788317],
	[0.94073133, 0.55885989, 0.52753041],
	[0.93922437, 0.55342842, 0.5273039],
	[0.93765055, 0.54802538, 0.52718525],
	[0.93601154, 0.5426504, 0.52717025],
	[0.93430891, 0.5373032, 0.52725441],
	[0.93254445, 0.5319833, 0.52743349],
	[0.93071921, 0.5266905, 0.52770523],
	[0.92883105, 0.52142642, 0.52807414],
	[0.9268874, 0.51618719, 0.52852475],
	[0.9248902, 0.51097201, 0.52905305],
	[0.92284124, 0.50578017, 0.52965475],
	[0.92074298, 0.50061017, 0.53032704],
	[0.91859742, 0.49546099, 0.53106625],
	[0.91640678, 0.49033124, 0.53186941],
	[0.9141732, 0.48521955, 0.53273353],
	[0.91189835, 0.48012505, 0.53365461],
	[0.90958468, 0.47504589, 0.53463071],
	[0.90723438, 0.46998039, 0.5356596],
	[0.90484912, 0.46492743, 0.53673784],
	[0.90243111, 0.45988514, 0.53786364],
	[0.89998264, 0.45485145, 0.53903578],
	[0.89750476, 0.44982577, 0.54024965],
	[0.89500032, 0.44480508, 0.54150622],
	[0.89247049, 0.43978848, 0.54280164],
	[0.88991764, 0.43477329, 0.54413615],
	[0.88734298, 0.42975839, 0.54550639],
	[0.8847489, 0.4247408, 0.54691338],
	[0.88213611, 0.41971991, 0.54835248],
	[0.87950715, 0.41469224, 0.54982587],
	[0.87686322, 0.40965623, 0.55133114],
	[0.87420354, 0.40461111, 0.55287281],
	[0.87152157, 0.39956286, 0.55445036],
	[0.86881693, 0.39451032, 0.55606908],
	[0.86608733, 0.38945556, 0.55772655],
	[0.86333188, 0.38439825, 0.55942636],
	[0.86054845, 0.37934024, 0.5611669],
	[0.85773392, 0.3742839, 0.5629503],
	[0.85488848, 0.36922858, 0.56477563],
	[0.85201127, 0.36417407, 0.56664577],
	[0.84910005, 0.35912265, 0.56855862],
	[0.8461534, 0.35407491, 0.57051639],
	[0.84316933, 0.34903272, 0.57251828],
	[0.84014489, 0.3439992, 0.57456325],
	[0.83707692, 0.33897761, 0.57665151],
	[0.8339651, 0.33396794, 0.57878355],
	[0.83080728, 0.32897284, 0.58095731],
	[0.82760156, 0.32399458, 0.58317212],
	[0.82434596, 0.31903571, 0.58542676],
	[0.82103864, 0.31409848, 0.58772116],
	[0.81767751, 0.30918623, 0.59005226],
	[0.81426068, 0.30430196, 0.59241829],
	[0.81078624, 0.29944896, 0.59481688],
	[0.80725235, 0.2946307, 0.59724527],
	[0.80365179, 0.28985862, 0.59969876],
	[0.79998182, 0.28513847, 0.60217328],
	[0.79624666, 0.28046597, 0.60466721],
	[0.79244485, 0.27584518, 0.60717662],
	[0.78857507, 0.27128035, 0.60969704],
	[0.78463614, 0.26677573, 0.61222407],
	[0.78061868, 0.26234905, 0.61474896],
	[0.77652351, 0.2580026, 0.61726721],
	[0.77235637, 0.25373078, 0.61977609],
	[0.76811689, 0.24953792, 0.62226981],
	[0.76380493, 0.24542812, 0.62474278],
	[0.75941192, 0.2414202, 0.62718508],
	[0.75493935, 0.23751652, 0.62959127],
	[0.75039516, 0.23370809, 0.63195914],
	[0.74578019, 0.22999811, 0.63428303],
	[0.74109545, 0.22638944, 0.63655739],
	[0.73633221, 0.22290286, 0.63877175],
	[0.73149654, 0.21953252, 0.64092326],
	[0.72659568, 0.2162699, 0.64301021],
	[0.72163146, 0.21311616, 0.64502825],
	[0.71660581, 0.21007204, 0.64697344],
	[0.711517, 0.20714522, 0.64883978],
	[0.70636196, 0.20434597, 0.65062099],
	[0.70115268, 0.2016551, 0.65231962],
	[0.69589147, 0.1990715, 0.65393346],
	[0.69058073, 0.19659365, 0.65546061],
	[0.68522296, 0.19421958, 0.65689925],
	[0.67982054, 0.19194708, 0.65824846],
	[0.67437469, 0.18977607, 0.65950652],
	[0.66888252, 0.18771456, 0.66066949],
	[0.66335376, 0.18574447, 0.66174204],
	[0.65779066, 0.18386243, 0.66272465],
	[0.65219626, 0.18206413, 0.66361648],
	[0.64657229, 0.18034622, 0.66441936],
	[0.64092036, 0.17870529, 0.66513536],
	[0.63525274, 0.17710745, 0.66579125],
	[0.62958792, 0.17551056, 0.66640738],
	[0.6239259, 0.1739149, 0.66698268],
	[0.6182663, 0.17232115, 0.66751667],
	[0.61260877, 0.17072997, 0.66800885],
	[0.60695268, 0.16914228, 0.66845908],
	[0.6012979, 0.16755858, 0.66886648],
	[0.59564403, 0.16597956, 0.6692305],
	[0.58999032, 0.16440736, 0.66954912],
	[0.58433544, 0.16284594, 0.66981869],
	[0.5786803, 0.16129178, 0.67004271],
	[0.57302438, 0.15974573, 0.67022075],
	[0.56736758, 0.15820828, 0.67035185],
	[0.56170951, 0.1566802, 0.67043541],
	[0.55604983, 0.15516218, 0.67047077],
	[0.55038821, 0.15365493, 0.67045725],
	[0.54472435, 0.15215913, 0.67039414],
	[0.53905789, 0.15067551, 0.67028082],
	[0.53338746, 0.14920851, 0.67011298],
	[0.52771214, 0.14776096, 0.66988802],
	[0.52203318, 0.14632799, 0.66961045],
	[0.51635042, 0.14491007, 0.66927948],
	[0.51066352, 0.14350783, 0.6688945],
	[0.50497223, 0.1421218, 0.66845484],
	[0.49927632, 0.14075245, 0.66795984],
	[0.49357549, 0.13940032, 0.66740894],
	[0.48786685, 0.13807535, 0.66679278],
	[0.48215207, 0.13677117, 0.666117],
	[0.47643161, 0.13548568, 0.66538328],
	[0.47070526, 0.13421915, 0.6645911],
	[0.46497279, 0.13297184, 0.66374001],
	[0.459234, 0.13174389, 0.66282956],
	[0.45348854, 0.13053601, 0.66185883],
	[0.44773276, 0.12936066, 0.66081621],
	[0.44197003, 0.12820507, 0.65971296],
	[0.43620013, 0.12706917, 0.65854885],
	[0.4304229, 0.12595278, 0.65732367],
	[0.42463813, 0.12485569, 0.65603729],
	[0.41884565, 0.1237776, 0.65468961],
	[0.41304282, 0.12272694, 0.6532726],
	[0.40723038, 0.12169996, 0.65178929],
	[0.40140959, 0.12069076, 0.65024467],
	[0.39558025, 0.11969877, 0.64863892],
	[0.38974215, 0.1187233, 0.64697227],
	[0.38389502, 0.11776368, 0.64524501],
	[0.37803795, 0.11682157, 0.6434552],
	[0.37216815, 0.1159051, 0.64159495],
	[0.3662885, 0.11500186, 0.63967537],
	[0.36039875, 0.11411078, 0.63769703],
	[0.35449848, 0.11323093, 0.63566058],
	[0.34858735, 0.11236116, 0.63356671],
	[0.34266495, 0.11150036, 0.63141617],
	[0.33672946, 0.110652, 0.62920542],
	[0.33077945, 0.10981815, 0.62693208],
	[0.32481666, 0.10898938, 0.62460491],
	[0.31884049, 0.10816437, 0.62222491],
	[0.31284626, 0.10734651, 0.6197935],
	[0.30683743, 0.10648648, 0.61737607],
	[0.30083458, 0.10552513, 0.61502171],
	[0.29484029, 0.10445744, 0.6127318],
	[0.28885498, 0.10328065, 0.61050789],
	[0.28287037, 0.1020009, 0.60835283],
	[0.27688466, 0.10061639, 0.60626887],
	[0.27090105, 0.09911971, 0.60425744],
	[0.26492236, 0.09750356, 0.60231991],
	[0.25893608, 0.09577514, 0.60046069],
	[0.25294688, 0.09392366, 0.59868109],
	[0.24695636, 0.09194079, 0.59698291],
	[0.24095305, 0.08982919, 0.59537122],
	[0.23494876, 0.08756893, 0.59384556],
	[0.22892763, 0.08516364, 0.59241265],
	[0.22289626, 0.08259509, 0.59107355],
	[0.21685562, 0.07984828, 0.5898308],
	[0.21079413, 0.07691596, 0.58869101],
	[0.20471468, 0.07377554, 0.58765674],
	[0.1986163, 0.07040369, 0.58673189],
	[0.19249902, 0.0667711, 0.58592026],
	[0.18635898, 0.06284452, 0.58522735],
	[0.18018928, 0.0585834, 0.58466028],
	[0.17399144, 0.05392757, 0.58422353],
	[0.16775825, 0.04880417, 0.58392544],
	[0.16149704, 0.04310032, 0.58376914],
	[0.15518431, 0.03671972, 0.58377105],
	[0.14881522, 0.0300271, 0.58394111],
	[0.14222837, 0.02320076, 0.58435875],
])*256

COUNTRIES_BY_AREA = {
	"VAT": 0.49,
	"PGA": 2.0,
	"CSI": 2.0,
	"BRI": 2.5,
	"MCO": 2.08,
	"GIB": 6.8,
	"CLP": 8.9,
	"TKL": 10,
	"IOA": 135 + 14,
	"UMI": 49.26,
	"NRU": 21,
	"BLM": 25,
	"TUV": 26,
	"MAC": 115.3,
	"SXM": 34,
	"NFK": 34.6,
	"PCN": 47,
	"MAF": 34,
	"BMU": 53.2,
	"IOT": 60,
	"SMR": 61.2,
	"GGY": 62,
	"USG": 117,
	"AIA": 91,
	"MSR": 102,
	"ATC": 112,
	"JEY": 119.6,
	"WLF": 142.42,
	"SCR": 150,
	"VGB": 153,
	"LIE": 160,
	"ABW": 179.64,
	"MHL": 181.43,
	"ASM": 200,
	"BJN": 234,
	"COK": 236.7,
	"SPM": 242,
	"WSB": 127,
	"ESB": 127,
	"NIU": 261.46,
	"KNA": 261,
	"CYM": 259,
	"MDV": 298,
	"SER": 1200,
}

density_bins = array([.02, 10, 20, 40, 80, 150, 300, 600, 1_200, 2_500])

swatches = stack(
	[
		interp(
			linspace(0, 1, size(density_bins) + 2),
			linspace(0, 1, shape(colormap)[0], endpoint=False),
			colormap[:, i]
		) for i in range(shape(colormap)[1])
	],
	axis=1)

binned_keys = [[] for i in range(len(density_bins) + 1)]
max_density = 0
total_area = 0
for shape, record in load_shaperecords("ne_10m_admin_0_countries"):
	population = record["pop_est"]
	if record["adm0_a3"] in COUNTRIES_BY_AREA:
		area = COUNTRIES_BY_AREA[record["adm0_a3"]]
	else:
		area = 0
		for i in range(len(shape.parts)):
			start_index = shape.parts[i]
			end_index = shape.parts[i + 1] if i + 1 < len(shape.parts) else None
			λ, ф = transpose(shape.points[start_index:end_index])
			x, y = 6371*radians(λ), 6371*sin(radians(ф))
			area += Polygon(stack([x, y], axis=1)).area
		if area < 300:
			raise ValueError(f"this area ({area:.0f}km² for {record['name']} is likely inaccurate.  please specify it manually.")
	density = population/area
	binned_keys[digitize(density, density_bins, right=True)].append(record["adm0_a3"])

	if density > max_density:
		max_density = density
	total_area += area

bin_ranges = [
	(
		density_bins[i - 1] if i > 0 else 0,
		density_bins[i] if i < len(density_bins) else max_density
	) for i in range(size(density_bins) + 1)
]

for (min_density, max_density), (r, g, b), keys in zip(bin_ranges, swatches, binned_keys):
	print(f"\t\t.{', .'.join(keys)} {{\n"
	      f"\t\t\tfill: #{int(r):02x}{int(g):02x}{int(b):02x}; /* {min_density}--{max_density:.0f} person/km^2 */\n"
	      f"\t\t}}")
